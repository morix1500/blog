---
title: "ゴミ出しを忘れないためのPush通知サービスを作った"
date: "2018-03-25T17:50:00+09:00"
slug: "000033"
tags: ["サービス", "PWA", "Vue.js", "Firebase"]
draft: false
eyecatch: "profile.jpg"
---
毎朝ゴミ出しのことを忘れて嫁に怒られてます。  
いい加減忘れないようにしたいので、  
**ゴミ出しを忘れないためのサービスを作りました！**

**ゴミ出し通知くん**です。  
<https://trash.haramishio.xyz>  

* [サービス概要](#%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E6%A6%82%E8%A6%81)
* [技術](#%E6%8A%80%E8%A1%93)
  * [モチベーション](#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)
      * [SPAまわり](#spa%E3%81%BE%E3%82%8F%E3%82%8A)
      * [PWAまわり](#pwa%E3%81%BE%E3%82%8F%E3%82%8A)
      * [サーバーまわり](#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%BE%E3%82%8F%E3%82%8A)
* [今後やりたいこと](#%E4%BB%8A%E5%BE%8C%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8)
* [最後に](#%E6%9C%80%E5%BE%8C%E3%81%AB)

## サービス概要
最初に各曜日で出すゴミを登録します。  
{{< figure src="/post/2018/03/25/gomi_cap1.png" >}}

日曜まで行くと登録ボタンが出ます。  
{{< figure src="/post/2018/03/25/gomi_cap2.png" >}}

登録後、一覧で見れます。  
{{< figure src="/post/2018/03/25/gomi_cap3.png" >}}

そして**毎朝7時**にPush通知が届きます。  
Push通知を届くようにするには、Pushを許可するようにしないといけないです。

今のところ、Push通知の時間は変えられないです。  
あと休みの日はPush通知は来ないようにしています。

あとChromeでしか動作確認をしていません。  
ほぼ自分用のサービスですが、使ってくださる方でバグなどあったら  
[Twitter](https://twitter.com/morix1500)で教えてください。。。

## 技術
主にこんな感じの技術を使ってます。  

* SPA(Vue.js)
* PWA(Service Worker)
* GCP Cloud Functions
* Firebase Hosting
* Firebase Realtime Database

アーキテクチャとワークフローは  
{{< figure src="/post/2018/03/25/gomidashi.png" >}}

1. ユーザはゴミ出し情報をブラウザで登録します
2. Service WorkerのInstall時にPushするための情報を、Cloud FunctionsにPOSTします
3. Cloud FunctionsはPush情報をRealtime Databaseに登録します
4. [cron-jobs.org](https://cron-job.org)でPush通知を送るためのCloud Functionsを呼び出し
5. Cloud FunctionsはPush情報を取得、一斉にPush通知
6. ユーザにPush通知が届く

ということで、サーバーレスで実現してます。

### モチベーション
なんでこの技術を使おうかと思ったモチベーションについてです。

#### SPAまわり
なんでこういう技術を採用したのかというお話をすると、  
PWAに興味があったので、それに付随する技術の習得を目的にしました。  
あと最近はインフラのことを中心に学習してたので、フロント界隈のことに疎くなってました。  
なのでVue.jsをちょっとかじってみるかぁと思ってやってみました！

ぶっちゃけこの程度のWebアプリならjQueryで十分だしそれに慣れてましたが  
僕がフロント界隈から離れている間にjQueryはすっかり嫌われてるようだったので、jQueryは使わないようにしました。
Vue.jsを触ってみると、導入も楽だし、双方向バインディングがこんな手間なくできるのかと感動しました。  

ほんとに大したことをやらないアプリなので、Webpackは使ってないです。  
使ったほうがコードがきれいになったと思うんですが、一気に色々覚えるのも大変だったので使いませんでした。

今後リファクタリングをやっていくつもりなので、そこでWebpackを使ってみようかと思います。  

デザインがイケてない？それはまぁそうっすね…

#### PWAまわり
個人的にPWAは、今後のWebの未来につながる技術だと思っていたので  
学ぶことが必須な技術だと思っていました。  

ちょうどいい機会だったので、Service Workerを使ってみて

* オフライン用キャッシュ
* Push通知

で使ってみることにしました。  
Service Workerについては[前回の記事](https://blog.haramishio.xyz/post/000032/)でも勉強しました。 

Push通知まわりがだいぶめんどくさく、  
Push通知用のエンドポイントや、通信のための公開鍵が発行できるので、
それをどこかに登録しておいて、Push通知したいときにその情報を使ってPush通知を行います。  

つまりフロントだけでは足りず、サーバー側の処理が必要になったので  
後述するCloud Functionsを使いました。

あとゴミのデータはIndexed DBを使いました。  
当初はLocal Storageにデータを保存していたのですが、  
Service Workerから参照できないことがわかったのでIndexed DBに変更しました。

#### サーバーまわり
この程度のサービスにサーバーを用意したくありません。  

SPAでフロントを作っていたので、静的ホスティングツールで提供できるのはわかっていたので  
Firebase Hostingを使用しました。  
Service Workerではhttpsが必須で、Firebase Hostingは独自ドメインでも証明書が無料なため相性がいいです。

Push通知のための情報登録や、Push通知を送るための仕組みは  
GCPのCloud Functionsを使用しました。  

これはAWS LambdaのようなFaasなのですが  
Cloud Functionsの良いところはhttpsフックでトリガーできるところです。  
LambdaだとAPI Gatewayを用意しないといけないところですが、その手間がなくて本当に楽でした。  

Cloud Functionsを使うので、自動的にDBはFirebase Realtime Databaseになりました。  

ただCloud Functionsはまだcronのような定期実行はできないようなので、  
[cron-jobs.org](https://cron-job.org)という無料でhttpフックしてくれるcronサービスを利用しました。

ということで、サーバーレスで実現できました。

## 今後やりたいこと
まだやり切れてないところが多々あります。

* リファクタリング
  * フロントまわりが汚すぎるのでリファクタリングしたい
* Push通知の時間帯指定
  * 毎朝7時はユーザーのことを考えてなさすぎなので、ユーザが指定できるようにしたい
* Webpack使いたい

## 最後に
PWAで作ったアプリは、スマホのホーム画面に追加して開くと  
ネイティブアプリと変わらないようなUIになります。それがめちゃくちゃ感動しました！  

個人的に初めて作ったサービスなので、ひとまずやり遂げたのはよかったかなぁと思ってます。  
ほかにもサービスの案があったりするので、順次実現していきたいなぁと思いました。

では！